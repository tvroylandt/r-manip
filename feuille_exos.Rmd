---
title: "Feuille d'exercice"
author: "Thomas Vroylandt"
date: "24 mars 2020"
output: html_document
params:
  correction: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

# Contexte

On va s'intéresser aux données de la STMT sur les demandeurs d'emploi pour la Creuse en 2019. L'idée va être de sortir les principales statistiques sur ces personnes et d'analyser quelques grandes répartitions.

# Packages

+ On créé un projet RStudio ;
+ On charge les packages qui vont nous être utiles.

```{r packages, include=params$correction}
library(tidyverse)
library(haven)
library(readxl)
```

# Import des données

+ Sauvegarder les données en local dans un dossier `data` au sein du projet ;
+ Importer les données dans un objet.

```{r import, include=params$correction}
df_stmt_creuse <- read_sas("data/stmt_2019_creuse.sas7bdat")
```

+ Visualiser ces données :
  
  + Combien de lignes ?
  + Combien de colonnes ?
  + A quoi ressemblent les données ?

```{r dim, include=params$correction}
dim(df_stmt_creuse)
```


```{r view, include=params$correction, eval = FALSE}
View(df_stmt_creuse)
```

+ Les types de variables sont-ils cohérents avec leur contenu ?
+ Sinon il faut recoder les variables (avec `as.character()` ou `as.numeric()`).

# Recodage des données

On va chercher ici à avoir des données propres :


## Renommer

+ Renommer les variables en minuscule ;

```{r rename, include=params$correction}
df_stmt_creuse_recode1 <- df_stmt_creuse %>%
  rename(
    moista = MOISTA,
    sex = SEX,
    typdem = TYPDEM,
    rome = ROME,
    catsta = CATSTA,
    trcancsta = TRCANCSTA,
    qlf = QLF,
    annnai = ANNNAI
  ) 
```

## Recodage des niveaux

+ Pour le ROME, charger le référentiel et le joindre pour obtenir les libellés ;

```{r ref_rome, include=params$correction}
ref_rome <- read_xlsx("data/ref_rome.xlsx")
```
+ Recoder le sexe en homme / femme ;
+ Regrouper l'ancienneté en - 6 mois / 6 mois à 1 an / 1 an et plus ;
+ Regrouper la qualification en employé / ouvrier / agent de maîtrise et technicien / cadre ;

```{r recodage, include=params$correction}
df_stmt_creuse_recode2 <- df_stmt_creuse_recode1 %>%
  left_join(ref_rome, by = c("rome" = "code_rome")) %>%
  mutate(
    sex = fct_recode(sex,
                     "Homme" = "1",
                     "Femme" = "2"),
    tr_anciennete = fct_collapse(
      trcancsta,
      "Moins de 6 mois" = c("10", "11"),
      "6 à 12 mois" = c("12"),
      "Un an et plus" = c("20", "30", "40")
    ),
    qualif = fct_collapse(
      qlf,
      "Ouvrier" = c("1", "2", "3", "4"),
      "Employé" = c("5", "6"),
      "AMT" = c("7", "8"),
      "Cadre" = "9"
    )
  )
```

## Calcul de variables

+ Calculer l'âge ;
+ Calculer l'année et le mois (avec la fonction `str_sub()`) ;

```{r calcul, include=params$correction}
df_stmt_creuse_recode3 <- df_stmt_creuse_recode2 %>%
  mutate(
    age = 2019 - annnai,
    annee = str_sub(moista, 1, 4),
    mois = str_sub(moista, 5, 7)
  ) 
```

## Sélection des variables

+ Ne sélectionner que les variables d'intérêt.

```{r select, include=params$correction}
df_stmt_creuse_recode <- df_stmt_creuse_recode3 %>%
  select(annee, mois, typdem, catsta, rome, lib_rome, sex, tr_anciennete, qualif, age)
```

# Calcul des agrégats

On va ici chercher à calculer le nombre de demandeurs d'emploi entrants, sortants et en fin de mois sur l'année, pour les DE en catégorie A, B, C.

## DEE, DES et DEFM

+ Filtrer sur les catégories A, B, C.

```{r filtrer, include=params$correction}
df_stmt_creuse_abc <- df_stmt_creuse_recode %>%
  filter(catsta %in% c("A", "B", "C"))
```

Les règles de gestion sont les suivantes (en fonction de la variable typdem):

+ les entrants : 3 et 4 ;
+ les sortants : 2 et 5 ;
+ la DEFM : 1 et 4.

Il faut donc :

+ Coder trois compteurs en fonction de typdem ;
+ Sommer ces compteurs par mois.

```{r agregats, include=params$correction}
df_stmt_agregat_creuse <- df_stmt_creuse_abc %>% 
  mutate(nb_dee = if_else(typdem %in% c("3", "4"), 1, 0),
         nb_des = if_else(typdem %in% c("2", "5"), 1, 0),
         nb_defm = if_else(typdem %in% c("1", "4"), 1, 0)) %>% 
  group_by(mois) %>% 
  summarise(nb_dee = sum(nb_dee),
            nb_des = sum(nb_des),
            nb_defm = sum(nb_defm)) %>%
  ungroup()

df_stmt_agregat_creuse
```

## Calcul de statistiques

On va faire une analyse rapide de ces données :

+ Calculer la DEFM moyenne sur l'année ;
+ Ainsi que l'écart-type.

```{r agregats_stats, include=params$correction}
df_stmt_agregat_creuse %>% 
  summarise(mean_defm = mean(nb_defm),
            sd_defm = sd(nb_defm))
```

## Par sexe

+ Refaire le calcul des agrégats par sexe ;

```{r agregats_sexe, include=params$correction}
df_stmt_agregat_creuse_sex <- df_stmt_creuse_abc %>% 
  mutate(nb_dee = if_else(typdem %in% c("3", "4"), 1, 0),
         nb_des = if_else(typdem %in% c("2", "5"), 1, 0),
         nb_defm = if_else(typdem %in% c("1", "4"), 1, 0)) %>% 
  group_by(mois, sex) %>% 
  summarise(nb_dee = sum(nb_dee),
            nb_des = sum(nb_des),
            nb_defm = sum(nb_defm)) %>%
  ungroup()

df_stmt_agregat_creuse_sex
```

+ Calculer la part des femmes dans la DEFM de chaque mois.

```{r agregats_part_femme, include=params$correction}
df_stmt_agregat_creuse_sex %>% 
  group_by(mois) %>% 
  mutate(part_femme = nb_defm / sum(nb_defm) * 100) %>% 
  ungroup() %>% 
  filter(sex == "Femme") %>% 
  select(mois, part_femme)
```

# Analyse de la DEFM de janvier


# Export des résultats


# BONUS : graphiques


